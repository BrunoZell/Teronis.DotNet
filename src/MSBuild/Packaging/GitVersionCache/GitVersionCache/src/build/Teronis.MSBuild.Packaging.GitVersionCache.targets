<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="Teronis.MSBuild.Packaging.GitVersionCache.props" Condition="'$(TeronisMSBuildPackagingGitVersionCacheHasBeenLoaded)' != 'true'" />
  
  <PropertyGroup>
    <WriteVersionInfoToBuildLog>false</WriteVersionInfoToBuildLog>
    <UpdateAssemblyInfo>false</UpdateAssemblyInfo>
    <GenerateGitVersionInformation>false</GenerateGitVersionInformation>
    <GetVersion>false</GetVersion>
  </PropertyGroup>
  
  <PropertyGroup>

    <GitVersionCacheTargetsFile>$(MSBuildThisFileDirectory)GitVersionCache.targets</GitVersionCacheTargetsFile>

    <GetVersionBeforeTargets>
      CoreCompile;
      GetAssemblyVersion;
      GenerateNuspec;
      _GenerateRestoreProjectSpec;
      _GetOutputItemsFromPack;
      EnsureWixToolsetInstalled
    </GetVersionBeforeTargets>

    <GetVersionCacheBeforeGetVersionTaskTargets>
      WriteVersionInfoToBuildLog;
      GenerateGitVersionInformation;
      GetVersion
    </GetVersionCacheBeforeGetVersionTaskTargets>

    <GetVersionCacheBeforeTargets>
      $(GetVersionBeforeTargets);
      $(GetVersionCacheBeforeGetVersionTaskTargets)
    </GetVersionCacheBeforeTargets>
    
  </PropertyGroup>

  <Target Name="_GetVersionCacheInline">
    <Exec Command="dotnet msbuild &quot;$(GitVersionCacheTargetsFile)&quot; -nologo &quot;-t:GetVersionCache;GetVersionCacheInline&quot;" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="GetVersionCacheInline" />
    </Exec>
  </Target>

  <Target Name="GetVersionCache" BeforeTargets="$(GetVersionCacheBeforeTargets)" DependsOnTargets="_GetVersionCacheInline" Condition="'$(DisableGitVersionCache)' != 'true'">

    <Message Text="##### GIT VERSION CACHE ####" Importance="high" />
    
    <PropertyGroup>
      <!--PrintDebug=true-->
      <GetVersionCacheInlinePropertyMSBuildProperties>
        GetVersionCacheInline=$(GetVersionCacheInline)
      </GetVersionCacheInlinePropertyMSBuildProperties>
    </PropertyGroup>
    
    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=Major">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_Major" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=Minor">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_Minor" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=Patch">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_Patch" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=PreReleaseTag">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_PreReleaseTag" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=PreReleaseTagWithDash">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_PreReleaseTagWithDash" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=PreReleaseLabel">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_PreReleaseLabel" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=PreReleaseNumber">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_PreReleaseNumber" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=BuildMetaData">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_BuildMetaData" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=BuildMetaDataPadded">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_BuildMetaDataPadded" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=FullBuildMetaData">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_FullBuildMetaData" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=MajorMinorPatch">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_MajorMinorPatch" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=SemVer">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_SemVer" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=LegacySemVer">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_LegacySemVer" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=LegacySemVerPadded">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_LegacySemVerPadded" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=AssemblySemVer">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_AssemblySemVer" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=AssemblySemFileVer">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_AssemblySemFileVer" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=FullSemVer">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_FullSemVer" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=InformationalVersion">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_InformationalVersion" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=BranchName">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_BranchName" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=Sha">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_Sha" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=NuGetVersionV2">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_NuGetVersionV2" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=NuGetVersion">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_NuGetVersion" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=NuGetPreReleaseTagV2">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_NuGetPreReleaseTagV2" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=NuGetPreReleaseTag">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_NuGetPreReleaseTag" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=CommitDate">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_CommitDate" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=CommitsSinceVersionSource">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_CommitsSinceVersionSource" />
    </MSBuild>

    <MSBuild Projects="$(GitVersionCacheTargetsFile)" Targets="GetVersionCacheInlineProperty" Properties="$(GetVersionCacheInlinePropertyMSBuildProperties);GetVersionPropertyName=CommitsSinceVersionSourcePadded">
      <Output TaskParameter="TargetOutputs" PropertyName="GitVersion_CommitsSinceVersionSourcePadded" />
    </MSBuild>

    <PropertyGroup Condition=" '$(UpdateVersionProperties)' == 'true' ">
      <Version>$(GitVersion_FullSemVer)</Version>
      <VersionPrefix>$(GitVersion_MajorMinorPatch)</VersionPrefix>
      <VersionSuffix Condition=" '$(UseFullSemVerForNuGet)' == 'false' ">$(GitVersion_NuGetPreReleaseTag)</VersionSuffix>
      <VersionSuffix Condition=" '$(UseFullSemVerForNuGet)' == 'true' ">$(GitVersion_PreReleaseTag)</VersionSuffix>
      <PackageVersion Condition=" '$(UseFullSemVerForNuGet)' == 'false' ">$(GitVersion_NuGetVersion)</PackageVersion>
      <PackageVersion Condition=" '$(UseFullSemVerForNuGet)' == 'true' ">$(GitVersion_FullSemVer)</PackageVersion>
      <InformationalVersion Condition=" '$(InformationalVersion)' == '' ">$(GitVersion_InformationalVersion)</InformationalVersion>
      <AssemblyVersion Condition=" '$(AssemblyVersion)' == '' ">$(GitVersion_AssemblySemVer)</AssemblyVersion>
      <FileVersion Condition=" '$(FileVersion)' == '' ">$(GitVersion_AssemblySemFileVer)</FileVersion>
      <RepositoryBranch Condition=" '$(RepositoryBranch)' == '' ">$(GitVersion_BranchName)</RepositoryBranch>
      <RepositoryCommit Condition=" '$(RepositoryCommit)' == '' ">$(GitVersion_Sha)</RepositoryCommit>
    </PropertyGroup>

  </Target>

</Project>
