<Project Sdk="Microsoft.NET.Sdk">

  <UsingTask TaskName="GetFirstItem" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v12.0.dll">
    <ParameterGroup>
      <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <FirstItem ParameterType="System.String" Output="true" Required="false" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.Linq" />
      <Code Type="Fragment" Language="cs">FirstItem = Items.First().ItemSpec;</Code>
    </Task>
  </UsingTask>

  <PropertyGroup>
    <ProjectBuildInPackageProjectId>Teronis.Packaging.ProjectBuildInPackage</ProjectBuildInPackageProjectId>
    
    <ProjectBuildInPackageProjectPath>$(MSBuildThisFileDirectory)..\..\src\bin\$(Configuration)</ProjectBuildInPackageProjectPath>
    <ProjectBuildInPackageProjectPath>$([System.IO.Path]::GetFullPath('$(ProjectBuildInPackageProjectPath)'))</ProjectBuildInPackageProjectPath>
    
    <RestoreSources>$(ProjectBuildInPackageProjectPath)</RestoreSources>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Test.Localization\Test.Localization.csproj" PrivateAssets="all" />
  </ItemGroup>

  <Target Name="dfdhgfhewr" BeforeTargets="CollectPackageReferences">

    <Message Text="[$(MSBuildThisFileName)] Try to find package $(ProjectBuildInPackageProjectId) in $(ProjectBuildInPackageProjectPath)" Importance="high" />

    <ItemGroup>
      <_ReleaseFiles Include="$(ProjectBuildInPackageProjectPath)\*.nupkg" />
    </ItemGroup>

    <Message Text="[$(MSBuildThisFileName)]  - found .nupkg: %(_ReleaseFiles.Identity)" Importance="high" />

    <GetFirstItem Items="%(_ReleaseFiles.Filename)">
      <Output TaskParameter="FirstItem" PropertyName="_ReleaseFile" />
    </GetFirstItem>

    <PropertyGroup>
      <ProjectBuildInPackageProjectVersion>$(_ReleaseFile.Replace($(ProjectBuildInPackageProjectId).,''))</ProjectBuildInPackageProjectVersion>
    </PropertyGroup>

    <Message Text="[$(MSBuildThisFileName)]  - evaluated version: $(ProjectBuildInPackageProjectVersion)" Importance="high" />

    <ItemGroup>
      <PackageReference Include="$(ProjectBuildInPackageProjectId)" Version="$(ProjectBuildInPackageProjectVersion)" />
    </ItemGroup>

    <Message Text="[$(MSBuildThisFileName)]  - added package reference $(ProjectBuildInPackageProjectId) ($(ProjectBuildInPackageProjectVersion))" Importance="high" />

  </Target>

</Project>